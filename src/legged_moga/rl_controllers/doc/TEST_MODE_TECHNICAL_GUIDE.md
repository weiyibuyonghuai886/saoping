# ç”µæœºæµ‹è¯•æ¨¡å¼æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ ç›®å½•
1. [æ§åˆ¶å‘¨æœŸ](#æ§åˆ¶å‘¨æœŸ)
2. [æ­£å¼¦æ³¢å‘½ä»¤è®¡ç®—](#æ­£å¼¦æ³¢å‘½ä»¤è®¡ç®—)
3. [å‘½ä»¤ä¸‹å‘æ¥å£](#å‘½ä»¤ä¸‹å‘æ¥å£)
4. [åŠ›çŸ©è®¡ç®—](#åŠ›çŸ©è®¡ç®—)
5. [æ•°æ®é‡‡æ ·ä¸è®°å½•](#æ•°æ®é‡‡æ ·ä¸è®°å½•)

---

## æ§åˆ¶å‘¨æœŸ

- **æ§åˆ¶é¢‘ç‡**: 1000 Hz (æ¯1æ¯«ç§’æ‰§è¡Œä¸€æ¬¡)
---

## æ­£å¼¦æ³¢å‘½ä»¤è®¡ç®—

### å…¬å¼

```
pos_des(t) = A + B Ã— sin(2Ï€ Ã— f Ã— t)

å…¶ä¸­:
A = (start_rad + end_rad) / 2        # ä¸­å¿ƒä½ç½®
B = (end_rad - start_rad) / 2         # æŒ¯å¹…
f = start_freq                        # é¢‘ç‡ (Hz)
t = ä»æµ‹è¯•å¼€å§‹çš„æ—¶é—´ (ç§’)
```

### YAMLå‚æ•°

```yaml
test_motor:
  start_rad: -0.1    # è¿åŠ¨ä¸‹é™ [rad]
  end_rad: 0.1       # è¿åŠ¨ä¸Šé™ [rad]
  start_freq: 1.0    # é¢‘ç‡ [Hz]
```

**è®¡ç®—**:
```
A = (-0.1 + 0.1) / 2 = 0.0 rad       # ä¸­å¿ƒä½ç½®
B = (0.1 - (-0.1)) / 2 = 0.1 rad     # æŒ¯å¹…
f = 1.0 Hz                            # é¢‘ç‡

åœ¨ t=0.00s:  pos_des = 0.0 + 0.1Ã—sin(0)      = 0.0 rad
åœ¨ t=0.25s:  pos_des = 0.0 + 0.1Ã—sin(Ï€/2)    = 0.1 rad
åœ¨ t=0.50s:  pos_des = 0.0 + 0.1Ã—sin(Ï€)      = 0.0 rad
åœ¨ t=0.75s:  pos_des = 0.0 + 0.1Ã—sin(3Ï€/2)   = -0.1 rad
åœ¨ t=1.00s:  pos_des = 0.0 + 0.1Ã—sin(2Ï€)     = 0.0 rad
```

**è½¨è¿¹**:
```
ä½ç½® (rad)
 0.1 |     â•±â•²
     |    â•±  â•²
 0.0 |â”€â”€â”€â•±â”€â”€â”€â”€â•²â”€â”€â”€â”€
     |         â•²  â•±
-0.1 |          â•²â•±
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ—¶é—´ (s)
     0   0.5   1.0
```

---

## å‘½ä»¤ä¸‹å‘æ¥å£

### æ¥å£å®šä¹‰

ç”µæœºé©±åŠ¨å™¨æ¥æ”¶5ä¸ªå‚æ•°ï¼š

```cpp
setCommand(pos_des, vel_des, kp, kd, feedforward)
```

| å‚æ•° | å•ä½ | è¯´æ˜ |
|------|------|------|
| `pos_des` | rad | ç›®æ ‡ä½ç½® (ä»æ­£å¼¦å…¬å¼è®¡ç®—) |
| `vel_des` | rad/s | ç›®æ ‡é€Ÿåº¦ (å›ºå®šä¸º0) |
| `kp` | Nm/rad | ä½ç½®å¢ç›Š (ä»YAMLè¯»å–) |
| `kd` | NmÂ·s/rad | é€Ÿåº¦å¢ç›Š (ä»YAMLè¯»å–) |
| `feedforward` | Nm | å‰é¦ˆåŠ›çŸ© (å›ºå®šä¸º0) |

### æµ‹è¯•å…³èŠ‚

```cpp
// æ¯ä¸ªæ§åˆ¶å‘¨æœŸ(1ms)æ‰§è¡Œä¸€æ¬¡
pos_des = A + B Ã— sin(2Ï€ft)           // ä»å…¬å¼è®¡ç®—å½“å‰æ—¶åˆ»ä½ç½®

setCommand(
    pos_des,              // ä¾‹å¦‚: 0.05 rad (æ­£å¼¦æ³¢å½“å‰å€¼)
    0.0,                  // é€Ÿåº¦å›ºå®šä¸º0
    test_motor_kp,        // ä»YAMLè¯»å–ï¼Œä¾‹å¦‚: 50.0
    test_motor_kd,        // ä»YAMLè¯»å–ï¼Œä¾‹å¦‚: 1.0
    0.0                   // å‰é¦ˆå›ºå®šä¸º0
);
```

## åŠ›çŸ©è®¡ç®—

### è®¡åˆ’åŠ›çŸ© (Planned Torque)

**PDæ§åˆ¶å™¨å…¬å¼**:
```
Ï„_planned = Kp Ã— (pos_des - pos_current) + Kd Ã— (0 - vel_current)
          = Kp Ã— ä½ç½®è¯¯å·® - Kd Ã— å½“å‰é€Ÿåº¦
```

**è®¡ç®—ç¤ºä¾‹**:

| å‚æ•° | å€¼ |
|------|----|
| pos_des | 0.1 rad |
| pos_current | 0.05 rad |
| vel_current | 0.2 rad/s |
| kp | 50.0 |
| kd | 1.0 |

```
position_error = 0.1 - 0.05 = 0.05 rad
velocity_error = 0.0 - 0.2 = -0.2 rad/s

Ï„_planned = 50.0 Ã— 0.05 + 1.0 Ã— (-0.2)
          = 2.5 - 0.2
          = 2.3 Nm
```

### åé¦ˆåŠ›çŸ© (Actual Torque)

**ç¡¬ä»¶è¯»å–**:

- **æ›´æ–°é¢‘ç‡**: 1000 Hz
- **æ•°æ®æ¥æº**: ç”µæœºé©±åŠ¨å™¨çš„åŠ›çŸ©ä¼ æ„Ÿå™¨åé¦ˆ

---

### è®°å½•çš„æ•°æ®

| å˜é‡å | è¯´æ˜ | å•ä½ |
|-------|------|------|
| Time | ä»æµ‹è¯•å¼€å§‹çš„æ—¶é—´ | s |
| Target_Position | æœŸæœ›ä½ç½® (pos_des) | rad |
| Current_Position | å®é™…ä½ç½® (pos_current) | rad |
| Torque_Command | è®¡åˆ’åŠ›çŸ© (Ï„_planned) | Nm |
| Torque_Current | å®é™…åŠ›çŸ© (Ï„_actual) | Nm |


## å®Œæ•´æµç¨‹ç¤ºä¾‹

### 1. é…ç½®æµ‹è¯•å‚æ•°

```yaml
test_motor:
  motor_id: 4           # æµ‹è¯•4å·ç”µæœº
  kp: 50.0              # ä½ç½®å¢ç›Š
  kd: 1.0               # é€Ÿåº¦å¢ç›Š
  start_rad: -0.1       # -0.1 rad
  end_rad: 0.1          # 0.1 rad
  start_freq: 1.0       # 1 Hz
  max_test_count: 5000  # 5000ä¸ªå‘¨æœŸ = 5ç§’
  decimation: 10        # æ¯10ä¸ªå‘¨æœŸè®°å½•ä¸€æ¬¡
```

### 2. è®¡ç®—å‚æ•°

```
ä¸­å¿ƒä½ç½® A = 0.0 rad
æŒ¯å¹… B = 0.1 rad
é¢‘ç‡ f = 1.0 Hz
```

### 3. æ§åˆ¶å¾ªç¯ (1000Hz)

```
t=0.000s (å‘¨æœŸ1):
  pos_des = 0.0 + 0.1Ã—sin(0) = 0.000 rad
  ä¸‹å‘: setCommand(0.000, 0, 50, 1, 0)
  è¯»å–: pos=0.005, vel=0.01, tau=0.23
  (ä¸è®°å½•)

t=0.001s (å‘¨æœŸ2):
  pos_des = 0.0 + 0.1Ã—sin(2Ï€Ã—1Ã—0.001) = 0.0006 rad
  ä¸‹å‘: setCommand(0.0006, 0, 50, 1, 0)
  è¯»å–: pos=0.007, vel=0.02, tau=0.28
...

t=0.010s (å‘¨æœŸ10):
  pos_des = 0.0 + 0.1Ã—sin(2Ï€Ã—1Ã—0.01) = 0.0062 rad
  ä¸‹å‘: setCommand(0.0062, 0, 50, 1, 0)
  è¯»å–: pos=0.0065, vel=0.05, tau=0.35
```

---
